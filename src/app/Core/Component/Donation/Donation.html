<div class="donation-container">
    <!-- Ìó§Îçî ÏòÅÏó≠ -->
    <div class="donation-header">
        <div class="header-content">
            <h1>Make a Good Friends</h1>
            <p>GlobalGivingÍ≥º Ìï®ÍªòÌïòÎäî ÏÑ∏Í≥ÑÏ†ÅÏù∏ ÎÇòÎàî ÌîÑÎ°úÏ†ùÌä∏</p>
            <div class="stats-summary">
                <span class="stat-item">
                    <mat-icon>public</mat-icon>
                    Ï¥ù {{ totalProjects() }}Í∞ú ÌîÑÎ°úÏ†ùÌä∏
                </span>
                <span class="stat-item">
                    <mat-icon>trending_up</mat-icon>
                    ÌèâÍ∑† {{ averageProgress() }}% Îã¨ÏÑ±
                </span>
            </div>
        </div>
        <div class="user-points-card">
            <div class="points-info">
                <span class="points-label">Î≥¥Ïú† Ìè¨Ïù∏Ìä∏</span>
                <span class="points-amount">{{ userPoints() | number }}P</span>
            </div>
            <button class="refresh-btn" (click)="refreshPoints()" [disabled]="isRefreshing()">
                <mat-icon [class.spin]="isRefreshing()">refresh</mat-icon>
            </button>
        </div>
    </div>

    <!-- Î°úÎî© ÏÉÅÌÉú -->
    @if (isLoading()) {
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <p>GlobalGivingÏóêÏÑú ÏµúÏã† Í∏∞Î∂Ä ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
    }

    <!-- ÏóêÎü¨ ÏÉÅÌÉú -->
    @else if (hasError()) {
        <div class="error-container">
            <mat-icon class="error-icon">error</mat-icon>
            <h3>ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</h3>
            <p>ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÍ≥† Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.</p>
            <button class="primary-button" (click)="loadDonationItems()">
                Îã§Ïãú ÏãúÎèÑ
            </button>
        </div>
    }

    <!-- Í∏∞Î∂Ä Ìï≠Î™© Î™©Î°ù -->
    @else {
        <!-- ÌïÑÌÑ∞ Î∞è Í≤ÄÏÉâ -->
        <div class="filter-section">
            <!-- Í≤ÄÏÉâ ÏòÅÏó≠ -->
            <div class="search-container">
                <div class="search-input-wrapper">
                    <mat-icon class="search-icon">search</mat-icon>
                    <input 
                        type="text"
                        class="search-input"
                        [(ngModel)]="searchTerm" 
                        (ngModelChange)="onSearchChange()"
                        placeholder="ÌîÑÎ°úÏ†ùÌä∏, Í∏∞Í¥ÄÎ™Ö, Íµ≠Í∞ÄÎ•º Í≤ÄÏÉâÌï¥Î≥¥ÏÑ∏Ïöî">
                    <button *ngIf="searchTerm" class="clear-search" (click)="searchTerm = ''; onSearchChange()">
                        <mat-icon>close</mat-icon>
                    </button>
                </div>
            </div>

            <!-- ÌïÑÌÑ∞ Ïª®Ìä∏Î°§ -->
            <div class="filter-controls">
                <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÌïÑÌÑ∞ Ïπ© -->
                <div class="filter-group">
                    <label class="filter-label">Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                    <div class="filter-chips">
                        <button 
                            *ngFor="let category of categories" 
                            class="filter-chip"
                            [class.active]="selectedCategory() === category"
                            (click)="setSelectedCategory(category)">
                            <mat-icon>{{ getCategoryIcon(category) }}</mat-icon>
                            <span>{{ category }}</span>
                        </button>
                    </div>
                </div>

                <!-- ÎìúÎ°≠Îã§Ïö¥ ÌïÑÌÑ∞Îì§ -->
                <div class="dropdown-filters">
                    <!-- ÌÖåÎßà ÌïÑÌÑ∞ -->
                    <div class="custom-select-wrapper">
                        <label class="select-label">ÌÖåÎßà</label>
                        <div class="custom-select" [class.active]="isThemeDropdownOpen" (click)="toggleThemeDropdown()">
                            <div class="select-trigger">
                                <mat-icon class="select-icon">{{ getThemeIcon() }}</mat-icon>
                                <span class="select-value">{{ getSelectedThemeLabel() }}</span>
                                <mat-icon class="dropdown-arrow" [class.rotated]="isThemeDropdownOpen">expand_more</mat-icon>
                            </div>
                            <div class="select-dropdown" *ngIf="isThemeDropdownOpen">
                                <div 
                                    *ngFor="let theme of themeOptions" 
                                    class="select-option"
                                    [class.selected]="selectedTheme() === theme.value"
                                    (click)="selectTheme(theme.value); $event.stopPropagation()">
                                    <mat-icon>{{ getThemeOptionIcon(theme.value) }}</mat-icon>
                                    <span>{{ theme.label }}</span>
                                    <mat-icon *ngIf="selectedTheme() === theme.value" class="check-icon">check</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Íµ≠Í∞Ä ÌïÑÌÑ∞ -->
                    <div class="custom-select-wrapper">
                        <label class="select-label">Íµ≠Í∞Ä</label>
                        <div class="custom-select" [class.active]="isCountryDropdownOpen" (click)="toggleCountryDropdown()">
                            <div class="select-trigger">
                                <mat-icon class="select-icon">{{ getCountryIcon() }}</mat-icon>
                                <span class="select-value">{{ getSelectedCountryLabel() }}</span>
                                <mat-icon class="dropdown-arrow" [class.rotated]="isCountryDropdownOpen">expand_more</mat-icon>
                            </div>
                            <div class="select-dropdown" *ngIf="isCountryDropdownOpen">
                                <div 
                                    *ngFor="let country of countryOptions" 
                                    class="select-option"
                                    [class.selected]="selectedCountry() === country.value"
                                    (click)="selectCountry(country.value); $event.stopPropagation()">
                                    <span class="country-flag">{{ getCountryFlag(country.value) }}</span>
                                    <span>{{ country.label }}</span>
                                    <mat-icon *ngIf="selectedCountry() === country.value" class="check-icon">check</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ï†ïÎ†¨ ÌïÑÌÑ∞ -->
                    <div class="custom-select-wrapper">
                        <label class="select-label">Ï†ïÎ†¨</label>
                        <div class="custom-select" [class.active]="isSortDropdownOpen" (click)="toggleSortDropdown()">
                            <div class="select-trigger">
                                <mat-icon class="select-icon">{{ getSortIcon() }}</mat-icon>
                                <span class="select-value">{{ getSortLabel() }}</span>
                                <mat-icon class="dropdown-arrow" [class.rotated]="isSortDropdownOpen">expand_more</mat-icon>
                            </div>
                            <div class="select-dropdown" *ngIf="isSortDropdownOpen">
                                <div 
                                    class="select-option"
                                    [class.selected]="sortBy === 'urgency'"
                                    (click)="selectSort('urgency'); $event.stopPropagation()">
                                    <mat-icon>priority_high</mat-icon>
                                    <span>Í∏¥Í∏âÎèÑÏàú</span>
                                    <mat-icon *ngIf="sortBy === 'urgency'" class="check-icon">check</mat-icon>
                                </div>
                                <div 
                                    class="select-option"
                                    [class.selected]="sortBy === 'progress'"
                                    (click)="selectSort('progress'); $event.stopPropagation()">
                                    <mat-icon>trending_up</mat-icon>
                                    <span>ÏßÑÌñâÎ•†Ïàú</span>
                                    <mat-icon *ngIf="sortBy === 'progress'" class="check-icon">check</mat-icon>
                                </div>
                                <div 
                                    class="select-option"
                                    [class.selected]="sortBy === 'amount'"
                                    (click)="selectSort('amount'); $event.stopPropagation()">
                                    <mat-icon>attach_money</mat-icon>
                                    <span>Î™©ÌëúÍ∏àÏï°Ïàú</span>
                                    <mat-icon *ngIf="sortBy === 'amount'" class="check-icon">check</mat-icon>
                                </div>
                                <div 
                                    class="select-option"
                                    [class.selected]="sortBy === 'newest'"
                                    (click)="selectSort('newest'); $event.stopPropagation()">
                                    <mat-icon>new_releases</mat-icon>
                                    <span>ÏµúÏã†Ïàú</span>
                                    <mat-icon *ngIf="sortBy === 'newest'" class="check-icon">check</mat-icon>
                                </div>
                                <div 
                                    class="select-option"
                                    [class.selected]="sortBy === 'remaining'"
                                    (click)="selectSort('remaining'); $event.stopPropagation()">
                                    <mat-icon>schedule</mat-icon>
                                    <span>ÎßàÍ∞êÏûÑÎ∞ïÏàú</span>
                                    <mat-icon *ngIf="sortBy === 'remaining'" class="check-icon">check</mat-icon>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÌïÑÌÑ∞ ÏÉÅÌÉú Î∞è Ïï°ÏÖò -->
            <div class="filter-status">
                <div class="active-filters">
                    <span class="results-badge">
                        <mat-icon>filter_list</mat-icon>
                        {{ filteredItems().length }}Í∞ú ÌîÑÎ°úÏ†ùÌä∏
                    </span>
                    
                    <!-- ÌôúÏÑ± ÌïÑÌÑ∞ ÌÉúÍ∑∏Îì§ -->
                    <div class="active-filter-tags">
                        <span *ngIf="selectedCategory() !== 'Ï†ÑÏ≤¥'" class="filter-tag">
                            <mat-icon>{{ getCategoryIcon(selectedCategory()) }}</mat-icon>
                            {{ selectedCategory() }}
                            <button (click)="setSelectedCategory('Ï†ÑÏ≤¥')" class="remove-filter">
                                <mat-icon>close</mat-icon>
                            </button>
                        </span>
                        
                        <span *ngIf="selectedTheme() !== 'all'" class="filter-tag">
                            <mat-icon>{{ getThemeOptionIcon(selectedTheme()) }}</mat-icon>
                            {{ getSelectedThemeLabel() }}
                            <button (click)="selectTheme('all')" class="remove-filter">
                                <mat-icon>close</mat-icon>
                            </button>
                        </span>
                        
                        <span *ngIf="selectedCountry() !== 'all'" class="filter-tag">
                            <span class="country-flag">{{ getCountryFlag(selectedCountry()) }}</span>
                            {{ getSelectedCountryLabel() }}
                            <button (click)="selectCountry('all')" class="remove-filter">
                                <mat-icon>close</mat-icon>
                            </button>
                        </span>
                        
                        <span *ngIf="searchTerm" class="filter-tag search-tag">
                            <mat-icon>search</mat-icon>
                            "{{ searchTerm }}"
                            <button (click)="searchTerm = ''; onSearchChange()" class="remove-filter">
                                <mat-icon>close</mat-icon>
                            </button>
                        </span>
                    </div>
                </div>
                
                <button 
                    *ngIf="hasActiveFilters()" 
                    class="reset-filters-btn" 
                    (click)="resetFilters()">
                    <mat-icon>clear_all</mat-icon>
                    Î™®Îì† ÌïÑÌÑ∞ ÏßÄÏö∞Í∏∞
                </button>
            </div>
        </div>

        <!-- ÌîÑÎ°úÏ†ùÌä∏ Í∑∏Î¶¨Îìú -->
        <div class="donation-grid">
            <div 
                *ngFor="let item of filteredItems()" 
                class="donation-card"
                [class.urgent]="item.urgency === 'high'"
                [class.globalgiving-project]="isGlobalGivingProject(item)">
                
                <div class="card-image" (click)="openDonationDialog(item)">
                    <img [src]="item.imageUrl" [alt]="item.title">
                    <div class="badge-container">
                        <div class="category-badge">
                            <mat-icon>{{ getCategoryIcon(item.category) }}</mat-icon>
                            {{ item.category }}
                        </div>
                        @if (item.urgency === 'high') {
                            <div class="urgency-badge">Í∏¥Í∏â</div>
                        }
                        @if (isGlobalGivingProject(item)) {
                            <div class="globalgiving-badge">
                                <mat-icon>public</mat-icon>
                                GlobalGiving
                            </div>
                        }
                    </div>
                </div>
                
                <div class="card-content">
                    <h3 (click)="openDonationDialog(item)">{{ item.title }}</h3>
                    <div class="organization-info">
                        <span class="organization">{{ item.organizationName }}</span>
                        @if (item.countryCode) {
                            <span class="country">{{ getCountryName(item.countryCode) }}</span>
                        }
                    </div>
                    <p class="description">{{ item.description }}</p>
                    
                    <div class="progress-section">
                        <div class="progress-info">
                            <span class="current">{{ item.currentAmount | number }}Ïõê</span>
                            <span class="target">/ {{ item.targetAmount | number }}Ïõê</span>
                        </div>
                        <div class="progress-bar-container">
                            <div 
                                class="progress-bar" 
                                [style.width.%]="getProgressPercentage(item)">
                            </div>
                        </div>
                        <div class="progress-details">
                            <span class="percentage">{{ getProgressPercentage(item) }}% Îã¨ÏÑ±</span>
                            <span class="remaining">{{ getRemainingAmount(item) | number }}Ïõê ÎÇ®Ïùå</span>
                        </div>
                    </div>
                    
                    <div class="card-actions">
                        <div class="donation-info">
                            <span class="min-donation">ÏµúÏÜå: {{ item.minDonation | number }}P</span>
                            @if (item.endDate) {
                                <span class="end-date">{{ getDaysRemaining(item.endDate) }}Ïùº ÎÇ®Ïùå</span>
                            }
                        </div>
                        
                        <div class="action-buttons">
                            <button class="secondary-button small" 
                                    (click)="viewProjectDetails(item)"
                                    [disabled]="!item.projectLink && !item.globalGivingId">
                                <mat-icon>info</mat-icon>
                                ÏÉÅÏÑ∏Î≥¥Í∏∞
                            </button>
                            <button class="primary-button small" (click)="openDonationDialog(item)">
                                <mat-icon>volunteer_activism</mat-icon>
                                Í∏∞Î∂ÄÌïòÍ∏∞
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Îçî ÎßéÏùÄ ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Î≤ÑÌäº -->
        @if (filteredItems().length > 0 && !isLoadingMore()) {
            <div class="load-more-section">
                <button class="secondary-button large" (click)="loadMoreProjects()">
                    <mat-icon>expand_more</mat-icon>
                    Îçî ÎßéÏùÄ ÌîÑÎ°úÏ†ùÌä∏ Î≥¥Í∏∞
                </button>
            </div>
        }

        @if (isLoadingMore()) {
            <div class="loading-more">
                <div class="loading-spinner small"></div>
                <p>Ï∂îÍ∞Ä ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
            </div>
        }

        <!-- Í∏∞Î∂Ä ÎÇ¥Ïó≠ ÏÑπÏÖò -->
        <div class="donation-history-section">
            <h2>ÎÇòÏùò Í∏∞Î∂Ä ÎÇ¥Ïó≠</h2>
            @if (donationHistory().length > 0) {
                <div class="history-list">
                    <div *ngFor="let record of donationHistory()" class="history-item">
                        <div class="history-info">
                            <h4>{{ getDonationItemTitle(record.donationItemId) }}</h4>
                            <p>{{ record.donationDate | date:'yyyy.MM.dd HH:mm' }}</p>
                        </div>
                        <div class="history-amount">
                            <span [class]="'status-' + record.status">{{ record.amount | number }}P</span>
                        </div>
                    </div>
                </div>
            } @else {
                <div class="empty-history">
                    <mat-icon>volunteer_activism</mat-icon>
                    <p>ÏïÑÏßÅ Í∏∞Î∂Ä ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.<br>GlobalGiving ÌîÑÎ°úÏ†ùÌä∏Î°ú Ï≤´ Î≤àÏß∏ Í∏∞Î∂ÄÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                </div>
            }
        </div>
    }
</div>

<!-- Í∏∞Î∂ÄÌïòÍ∏∞ Îã§Ïù¥ÏñºÎ°úÍ∑∏ -->
@if (selectedItem()) {
    <div class="donation-dialog-overlay" (click)="closeDonationDialog()">
        <div class="donation-dialog" (click)="$event.stopPropagation()">
            <div class="dialog-header">
                <div class="dialog-title-section">
                    <h2>{{ selectedItem()?.title }}</h2>
                    @if (isGlobalGivingProject(selectedItem()!)) {
                        <div class="globalgiving-badge dialog">
                            <mat-icon>public</mat-icon>
                            GlobalGiving ÌîÑÎ°úÏ†ùÌä∏
                        </div>
                    }
                </div>
                <button class="close-btn" (click)="closeDonationDialog()">
                    <mat-icon>close</mat-icon>
                </button>
            </div>
            
            <div class="dialog-content">
                <div class="item-summary">
                    <img [src]="selectedItem()?.imageUrl" [alt]="selectedItem()?.title">
                    <div class="summary-info">
                        <div class="organization-country">
                            <p class="organization">{{ selectedItem()?.organizationName }}</p>
                            @if (selectedItem()?.countryCode) {
                                <p class="country">üìç {{ getCountryName(selectedItem()?.countryCode) }}</p>
                            }
                        </div>
                        <p class="description">{{ selectedItem()?.description }}</p>
                        <div class="progress-mini">
                            <span>ÌòÑÏû¨ {{ getProgressPercentage(selectedItem()!) }}% Îã¨ÏÑ±</span>
                            <div class="progress-bar-mini">
                                <div class="progress-fill" [style.width.%]="getProgressPercentage(selectedItem()!)"></div>
                            </div>
                        </div>
                        
                        @if (selectedItem()?.projectLink || selectedItem()?.globalGivingId) {
                            <button class="link-button" (click)="viewProjectDetails(selectedItem()!)">
                                <mat-icon>open_in_new</mat-icon>
                                ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î≥¥Í∏∞
                            </button>
                        }
                    </div>
                </div>
                
                <div class="donation-form">
                    <label>Í∏∞Î∂ÄÌï† Ìè¨Ïù∏Ìä∏</label>
                    <div class="amount-input">
                        <input 
                            type="number" 
                            [(ngModel)]="donationAmount"
                            [min]="selectedItem()?.minDonation ?? 0"
                            [max]="userPoints()"
                            placeholder="Í∏∞Î∂ÄÌï† Ìè¨Ïù∏Ìä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                        <span>P</span>
                    </div>
                    
                    <div class="quick-amounts">
                        <button 
                            *ngFor="let amount of getQuickAmounts()"
                            type="button"
                            class="quick-amount-btn"
                            [class.disabled]="amount > userPoints()"
                            (click)="setDonationAmount(amount)"
                            [disabled]="amount > userPoints()">
                            {{ amount | number }}P
                        </button>
                    </div>
                    
                    <div class="donation-summary">
                        <div class="summary-row">
                            <span>Í∏∞Î∂Ä Ìè¨Ïù∏Ìä∏:</span>
                            <span class="amount">{{ donationAmount | number }}P</span>
                        </div>
                        <div class="summary-row">
                            <span>Í∏∞Î∂Ä ÌõÑ ÏûîÏó¨:</span>
                            <span class="remaining">{{ (userPoints() - donationAmount) | number }}P</span>
                        </div>
                        @if (isGlobalGivingProject(selectedItem()!)) {
                            <div class="summary-note">
                                <mat-icon>info</mat-icon>
                                <span>Ïù¥ Í∏∞Î∂ÄÎäî GlobalGivingÏùÑ ÌÜµÌï¥ Ï†Ñ ÏÑ∏Í≥ÑÏ†ÅÏúºÎ°ú ÏòÅÌñ•ÏùÑ ÎØ∏Ïπ©ÎãàÎã§.</span>
                            </div>
                        }
                    </div>
                    
                    <div class="dialog-actions">
                        <button 
                            type="button" 
                            class="secondary-button"
                            (click)="closeDonationDialog()">
                            Ï∑®ÏÜå
                        </button>
                        <button 
                            type="button" 
                            class="primary-button"
                            (click)="processDonation()"
                            [disabled]="!isValidDonation() || isProcessing()">
                            @if (isProcessing()) {
                                <mat-icon class="spin">hourglass_empty</mat-icon>
                                Ï≤òÎ¶¨Ï§ë...
                            } @else {
                                <mat-icon>volunteer_activism</mat-icon>
                                @if (isGlobalGivingProject(selectedItem()!)) {
                                    Ï†Ñ ÏÑ∏Í≥ÑÏóê Í∏∞Î∂ÄÌïòÍ∏∞
                                } @else {
                                    Í∏∞Î∂ÄÌïòÍ∏∞
                                }
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}