<div class="activity-dashboard">
  <!-- 로딩 상태 -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p>활동 데이터를 불러오는 중...</p>
      </div>
    </div>
  }
  
  <!-- 대시보드 내용 -->
  @else {
    <!-- 헤더 -->
    <div class="dashboard-header">
      <div class="header-content">
        <h1>나의 활동 현황</h1>
        <p class="page-description">개인 활동 기록과 성장 패턴을 확인해보세요</p>
      </div>
      <div class="header-actions">
        <button class="refresh-btn" (click)="refreshData()">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>
    </div>

    <!-- 주요 통계 카드 -->
    <div class="stats-section">
      <div class="stats-grid">
        @for (stat of weeklyStats(); track stat.label) {
          <div class="stat-card" [class.trending]="stat.trend === 'up'" [style.--stat-color]="stat.color">
            <div class="stat-icon" [style.background]="'linear-gradient(135deg, ' + stat.color + ', ' + stat.color + '99)'">
              <mat-icon>{{ stat.icon }}</mat-icon>
            </div>
            <div class="stat-content">
              <div class="stat-value">
                {{ stat.value }}{{ stat.unit }}
                @if (stat.trend) {
                  <span class="stat-trend" [class]="stat.trend">
                    @if (stat.trend === 'up') { ↗ }
                    @else if (stat.trend === 'down') { ↘ }
                    @else { → }
                  </span>
                }
              </div>
              <div class="stat-label">{{ stat.label }}</div>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- 스마트 인사이트 섹션 -->
    @if (smartInsights().length > 0) {
      <div class="insights-section">
        <div class="section-card">
          <div class="section-header">
            <h2>💡 개인화된 인사이트</h2>
            <div class="insight-summary">
              @if (hasHighPriorityInsights()) {
                <span style="color: #3182ce; font-weight: 600;">🔥 주목할 성과가 있어요!</span>
              }
            </div>
          </div>
          
          <div class="insights-grid">
            @for (insight of smartInsights(); track insight.message; let i = $index) {
              @if (i < 3) {
                <div class="insight-card" [class.high-priority]="insight.priority === 'high'">
                  <div class="insight-icon">{{ getInsightIcon(insight) }}</div>
                  <div class="insight-content">
                    <p class="insight-message">{{ insight.message }}</p>
                    @if (insight.suggestion) {
                      <p class="insight-suggestion">{{ insight.suggestion }}</p>
                    }
                  </div>
                  <div class="priority-indicator" [class]="insight.priority"></div>
                </div>
              }
            }
          </div>
        </div>
      </div>
    }

    <!-- 주간 퀘스트 현황 - 데이터 검증 추가 -->
    @if (activityData(); as data) {
      <div class="section-card">
        <div class="section-header">
          <h2>📊 이번 주 퀘스트 현황</h2>
          <div class="completion-rate">
            <span class="rate-number">{{ getCompletionRate() }}%</span>
            <span class="rate-label">완료율</span>
          </div>
        </div>
        
        <!-- 유효한 데이터가 있을 때만 차트 표시 -->
        @if (data.dailyQuests && data.dailyQuests.length > 0) {
          <div class="daily-quest-chart">
            @for (day of data.dailyQuests; track day.date) {
              <div class="day-column">
                <div class="day-label">{{ day.date }}</div>
                <div class="day-bars">
                  <div class="quest-bar-container">
                    <div class="quest-bar completed" 
                         [style.height.%]="getSafePercentage(day.completed, day.target)">
                    </div>
                    <div class="quest-bar total"></div>
                  </div>
                  <div class="day-numbers">
                    <span class="completed">{{ day.completed || 0 }}</span>
                    <span class="separator">/</span>
                    <span class="total">{{ day.target || 0 }}</span>
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <!-- 데이터가 없을 때 표시할 메시지 -->
          <div style="text-align: center; padding: 40px; color: #718096;">
            <mat-icon style="font-size: 48px; color: #cbd5e0; margin-bottom: 16px;">assessment</mat-icon>
            <h3 style="color: #4a5568; margin: 16px 0 8px 0;">아직 이번 주 퀘스트 데이터가 없습니다</h3>
            <p style="margin: 0;">첫 번째 퀘스트를 완료하면 여기에 진행 상황이 표시됩니다.</p>
          </div>
        }
      </div>

      <!-- 활동 패턴 분석 - 데이터 검증 추가 -->
      <div class="section-card">
        <div class="section-header">
          <h2>📈 일별 활동 패턴 분석</h2>
          @if (data.personalizedStats?.groupStats) {
            <div class="pattern-insights">
              <span class="insight-item">
                <strong>참여 그룹:</strong> {{ data.personalizedStats.groupStats.totalGroups || 0 }}개
              </span>
              <span class="insight-item">
                <strong>활발한 그룹:</strong> {{ data.personalizedStats.groupStats.mostActiveGroup || '없음' }}
              </span>
            </div>
          }
        </div>
        
        @if (data.weeklyPattern && data.weeklyPattern.length > 0) {
          <div class="weekly-pattern">
            @for (dayData of data.weeklyPattern; track dayData.day) {
              <div class="pattern-day">
                <div class="pattern-day-label">{{ dayData.day }}</div>
                <div class="pattern-bar">
                  <div class="pattern-fill" 
                       [style.width.%]="getPatternBarWidth(dayData.totalActivities, data.weeklyPattern)"
                       [style.background-color]="getPatternBarColor(dayData.totalActivities, data.weeklyPattern)"
                       [title]="getActivityLevel(dayData.totalActivities, data.weeklyPattern)">
                  </div>
                </div>
                <div class="pattern-count">{{ dayData.totalActivities || 0 }}</div>
                <div class="pattern-level">{{ getActivityLevel(dayData.totalActivities, data.weeklyPattern) }}</div>
              </div>
            }
          </div>

          <!-- 활동 패턴 범례 및 통계 -->
          <div class="pattern-legend">
            <div class="legend-item">
              <div class="legend-color" style="background-color: #3182ce;"></div>
              <span>매우 활발</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #4299e1;"></div>
              <span>활발</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #63b3ed;"></div>
              <span>보통</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #90cdf4;"></div>
              <span>낮음</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #e2e8f0;"></div>
              <span>휴식</span>
            </div>
          </div>

          <div class="pattern-stats">
            <div class="pattern-stat">
              <span class="pattern-stat-value">{{ getWeeklyTotal(data.weeklyPattern) }}</span>
              <span class="pattern-stat-label">주간 총합</span>
            </div>
            <div class="pattern-stat">
              <span class="pattern-stat-value">{{ getWeeklyAverage(data.weeklyPattern) }}</span>
              <span class="pattern-stat-label">일평균</span>
            </div>
            <div class="pattern-stat">
              <span class="pattern-stat-value">{{ getMostActiveDay(data.weeklyPattern) }}</span>
              <span class="pattern-stat-label">최고 활동일</span>
            </div>
            <div class="pattern-stat">
              <span class="pattern-stat-value">{{ getActiveDays(data.weeklyPattern) }}</span>
              <span class="pattern-stat-label">활동일수</span>
            </div>
          </div>
        } @else {
          <!-- 주간 패턴 데이터가 없을 때 -->
          <div style="text-align: center; padding: 40px; color: #718096;">
            <mat-icon style="font-size: 48px; color: #cbd5e0; margin-bottom: 16px;">timeline</mat-icon>
            <h3 style="color: #4a5568; margin: 16px 0 8px 0;">주간 활동 패턴을 분석중입니다</h3>
            <p style="margin: 0;">더 많은 활동을 완료하면 패턴 분석이 가능합니다.</p>
          </div>
        }
      </div>
    } @else {
      <!-- 전체 활동 데이터가 없을 때 -->
      <div class="section-card">
        <div style="text-align: center; padding: 60px; color: #718096;">
          <mat-icon style="font-size: 64px; color: #cbd5e0; margin-bottom: 24px;">insights</mat-icon>
          <h2 style="color: #4a5568; margin: 24px 0 16px 0;">활동 데이터를 불러오는 중입니다</h2>
          <p style="margin: 0; font-size: 16px;">잠시만 기다려주세요. 곧 활동 현황이 표시됩니다.</p>
        </div>
      </div>
    }

    <!-- 최근 활동 타임라인 - 우선순위 기반 -->
    <div class="section-card">
      <div class="section-header">
        <h2>🎯 주요 최근 활동</h2>
        <div class="activity-summary">
          중요한 활동 {{ recentActivities().length }}개
        </div>
      </div>
      
      @if (recentActivities().length > 0) {
        <div class="activity-timeline">
          @for (activity of recentActivities(); track activity.id; let i = $index) {
            @if (i < 6) {
              <div class="timeline-item">
                <div class="timeline-marker">
                  <div class="activity-icon">{{ activity.icon }}</div>
                </div>
                <div class="timeline-content">
                  <div class="priority-indicator" [class]="activity.priority"></div>
                  <div class="activity-header">
                    <h4 class="activity-title">{{ activity.title }}</h4>
                    <div class="activity-meta">
                      <span class="activity-badge" 
                            [style.background]="getActivityTypeColor(activity.type)">
                        {{ getActivityTypeBadge(activity.type) }}
                      </span>
                      @if (activity.points) {
                        <span class="activity-points">+{{ activity.points }}pt</span>
                      }
                      <span class="activity-time">{{ getTimeAgo(activity.timestamp) }}</span>
                    </div>
                  </div>
                  <p class="activity-description">{{ activity.description }}</p>
                </div>
              </div>
            }
          }
        </div>

        <!-- 전체 활동 보기 버튼 -->
        @if (recentActivities().length > 6) {
          <div class="timeline-footer">
            <button class="btn btn-secondary">
              <mat-icon>visibility</mat-icon>
              전체 활동 보기
            </button>
          </div>
        }
      } @else {
        <!-- 활동이 없을 때 표시할 메시지 -->
        <div class="timeline-footer">
          <div style="text-align: center; padding: 40px; color: #718096;">
            <mat-icon style="font-size: 48px; color: #cbd5e0; margin-bottom: 16px;">insights</mat-icon>
            <h3 style="color: #4a5568; margin: 16px 0 8px 0;">활동을 시작해보세요!</h3>
            <p style="margin: 0;">첫 번째 퀘스트를 완료하거나 그룹에 참여해보세요.</p>
          </div>
        </div>
      }
    </div>
  }
</div>