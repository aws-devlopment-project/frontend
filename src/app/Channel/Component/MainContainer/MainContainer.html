<div class="chat-container">
  <!-- ì±„íŒ… í—¤ë” -->
  <div class="chat-header">
    <div class="channel-info">
      <h3># {{ currentChannel().name || 'ì±„ë„' }}</h3>
      <div class="channel-status">
        <p>ì‹¤ì‹œê°„ ì±„íŒ…ë°© (Club ID: {{ chatRoomId() }})</p>
        <div class="connection-status" [class]="getConnectionStatusClass()">
          <mat-icon class="status-icon">
            {{ connectionStatus() === 'connected' ? 'wifi' : 
               connectionStatus() === 'connecting' ? 'wifi_tethering' : 
               connectionStatus() === 'reconnecting' ? 'sync' : 'wifi_off' }}
          </mat-icon>
          <span>{{ getConnectionStatusText() }}</span>
        </div>
      </div>
    </div>
    <div class="chat-actions">
      <button class="header-btn" title="ì—°ê²° í…ŒìŠ¤íŠ¸" (click)="testConnection()">
        <mat-icon>network_check</mat-icon>
      </button>
      @if (connectionStatus() === 'disconnected') {
        <button class="header-btn reconnect-btn" title="ë‹¤ì‹œ ì—°ê²°" (click)="reconnect()">
          <mat-icon>refresh</mat-icon>
        </button>
      }
    </div>
  </div>

  <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
  <div class="chat-messages" #messagesContainer>
    @if (messages().length === 0) {
      <div class="welcome-message">
        <div class="welcome-content">
          <h4>ğŸ‰ ì±„íŒ…ë°©ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h4>
          <p>STOMP over WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ì±„íŒ…ì„ ì¦ê²¨ë³´ì„¸ìš”.</p>
          
          @if (connectionStatus() === 'connected') {
            <div class="conversation-starters">
              <h5>ëŒ€í™” ì‹œì‘í•˜ê¸°</h5>
              <div class="starter-buttons">
                <button class="starter-btn" (click)="sendMessage('ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹')">
                  ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹
                </button>
                <button class="starter-btn" (click)="sendMessage('ì±„íŒ… í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.')">
                  ì±„íŒ… í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.
                </button>
                <button class="starter-btn" (click)="sendMessage('ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!')">
                  ì¢‹ì€ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!
                </button>
              </div>
            </div>
          } @else {
            <div class="connection-waiting">
              <mat-icon class="loading-icon">{{ 
                connectionStatus() === 'connecting' ? 'hourglass_empty' :
                connectionStatus() === 'reconnecting' ? 'sync' : 'error_outline'
              }}</mat-icon>
              <p>{{ getConnectionStatusText() }}</p>
              @if (connectionStatus() === 'disconnected') {
                <button class="reconnect-button" (click)="reconnect()">
                  <mat-icon>refresh</mat-icon>
                  ë‹¤ì‹œ ì—°ê²°
                </button>
              }
            </div>
          }
        </div>
      </div>
    } @else {
      @for (message of messages(); track message.id) {
        <div class="message-group" 
             [class.own-message]="message.isOwn"
             [class.system-message]="message.type === 'system'">
          
          @if (message.type !== 'system') {
            <div class="message-avatar">
              <div class="avatar-placeholder" [class.online]="connectionStatus() === 'connected'">
                {{ message.senderUsername.charAt(0).toUpperCase() }}
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <div class="online-indicator"></div>
                }
              </div>
            </div>
            
            <div class="message-content">
              <div class="message-header">
                <span class="username">{{ message.senderUsername }}</span>
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <span class="online-badge">ì˜¨ë¼ì¸</span>
                }
                <span class="timestamp">{{ formatTime(message.timestamp) }}</span>
              </div>
              
              <!-- ì±„íŒ… ë©”ì‹œì§€ -->
              @if (message.messageType === 'CHAT') {
                <div class="message-text">{{ message.content }}</div>
              } @else if (message.messageType === 'IMAGE') {
                <div class="message-text">
                  <img
                    [src]="message.content"
                    alt="ì´ë¯¸ì§€"
                    stlye="max-width: 200px; border-radius-8px;" />
                </div>
              }
              
              <!-- ì…ì¥/í‡´ì¥ ë©”ì‹œì§€ -->
              @if (message.messageType === 'JOIN' || message.messageType === 'LEAVE') {
                <div class="message-text system-notice">
                  <mat-icon>{{ message.messageType === 'JOIN' ? 'login' : 'logout' }}</mat-icon>
                  {{ message.content }}
                </div>
              }
            </div>
          } @else {
            <!-- ì‹œìŠ¤í…œ ë©”ì‹œì§€ -->
            <div class="system-message-content">
              <mat-icon class="system-icon">info</mat-icon>
              <span class="system-text">{{ message.content }}</span>
              <span class="system-time">{{ formatTime(message.timestamp) }}</span>
            </div>
          }
        </div>
      }
    }
  </div>

  <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
  <div class="chat-input-area">
    <div class="input-container" [class.disabled]="connectionStatus() !== 'connected'">
      <input type="file" accept="image/*" (change)="onImageSelected($event)" style="display:none" #imageInput>
      <button class="send-btn" (click)="imageInput.click()">
        <mat-icon>image</mat-icon>
      </button>
      <textarea
        class="message-input"
        [(ngModel)]="newMessage"
        [placeholder]="getInputPlaceholder()"
        [disabled]="connectionStatus() !== 'connected'"
        (keydown)="onKeyDown($event)"
        rows="1">
      </textarea>
      
      <button 
        class="send-btn" 
        [disabled]="!newMessage().trim() || connectionStatus() !== 'connected'"
        (click)="sendCurrentMessage()"
        title="ë©”ì‹œì§€ ì „ì†¡">
        <mat-icon>send</mat-icon>
      </button>
    </div>
    
    <div class="input-hints">
      @if (connectionStatus() === 'connected') {
        <span><strong>Enter</strong>ë¡œ ì „ì†¡, <strong>Shift + Enter</strong>ë¡œ ì¤„ë°”ê¿ˆ</span>
      } @else {
        <span class="connection-hint">{{ getConnectionStatusText() }} - ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
      }
    </div>
  </div>
</div>