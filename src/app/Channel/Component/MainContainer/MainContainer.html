<!-- UpdatedMainContainer.html - ë°±ì—”ë“œ ì˜ˆì‹œì— ë§ì¶˜ STOMP ê¸°ë°˜ í…œí”Œë¦¿ -->
<div class="chat-container">
  <!-- ì±„íŒ… í—¤ë” -->
  <div class="chat-header">
    <div class="channel-info">
      <h3># {{ channelInfo()?.name || currentChannel() || 'ì±„ë„' }}</h3>
      <div class="channel-status">
        <p>{{ channelInfo()?.description || getChannelDescription(currentChannel().name) }}</p>
        <div class="connection-status" [class]="getConnectionStatusClass()">
          <mat-icon class="status-icon">
            {{ connectionStatus() === 'connected' ? 'wifi' : 
               connectionStatus() === 'connecting' ? 'wifi_tethering' : 
               connectionStatus() === 'reconnecting' ? 'sync' : 'wifi_off' }}
          </mat-icon>
          <span>{{ getConnectionStatusText() }}</span>
          @if (connectionStatus() === 'connected' && chatRoomId() !== -1) {
            <span class="room-id">â€¢ Club {{ chatRoomId() }}</span>
          }
        </div>
      </div>
    </div>
    <div class="chat-actions">
      <button class="header-btn" title="í†µê³„ ë³´ê¸°"
              (click)="showStats()">
        <mat-icon>analytics</mat-icon>
        @if (messageStats().count > 0) {
          <span class="message-count-badge">{{ messageStats().count }}</span>
        }
      </button>
      <button class="header-btn" title="ì—°ê²° í…ŒìŠ¤íŠ¸"
              (click)="testConnection()">
        <mat-icon>network_check</mat-icon>
      </button>
      <button class="header-btn" title="í˜„ì¬ ì±„ë„ ì´ë ¥ ì‚­ì œ" 
              [disabled]="messages().length === 0"
              (click)="clearCurrentChannelHistory()">
        <mat-icon>delete_sweep</mat-icon>
      </button>
      @if (connectionStatus() === 'disconnected') {
        <button class="header-btn reconnect-btn" title="ë‹¤ì‹œ ì—°ê²°" (click)="reconnect()">
          <mat-icon>refresh</mat-icon>
        </button>
      }
      <button class="header-btn" title="ë°ëª¨ ë©”ì‹œì§€ ì¶”ê°€"
              [disabled]="connectionStatus() !== 'connected'"
              (click)="addDemoMessage()">
        <mat-icon>message</mat-icon>
      </button>
    </div>
  </div>

  <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
  <div class="chat-messages" #messagesContainer>
    @if (messages().length === 0) {
      <div class="welcome-message">
        <div class="welcome-content">
          <h4>ğŸ‰ {{ getWelcomeTitle() }}</h4>
          <p>{{ getWelcomeMessage() }}</p>
          
          @if (connectionStatus() === 'connected') {
            <div class="conversation-starters">
              <h5>ëŒ€í™” ì‹œì‘í•˜ê¸°</h5>
              <div class="starter-buttons">
                @for (starter of getConversationStarters(); track starter) {
                  <button class="starter-btn" (click)="sendMessage(starter)">
                    {{ starter }}
                  </button>
                }
              </div>
            </div>
          } @else {
            <div class="connection-waiting">
              <mat-icon class="loading-icon">{{ 
                connectionStatus() === 'connecting' ? 'hourglass_empty' :
                connectionStatus() === 'reconnecting' ? 'sync' : 'error_outline'
              }}</mat-icon>
              <p>{{ getConnectionStatusText() }}</p>
              @if (connectionStatus() === 'disconnected') {
                <button class="reconnect-button" (click)="reconnect()">
                  <mat-icon>refresh</mat-icon>
                  ë‹¤ì‹œ ì—°ê²°
                </button>
              }
            </div>
          }
        </div>
      </div>
    } @else {
      @for (message of messages(); track message.id) {
        <div class="message-group" 
             [class.own-message]="message.isOwn"
             [class.system-message]="message.type === 'system'">
          
          @if (message.type !== 'system') {
            <div class="message-avatar">
              <div class="avatar-placeholder" [class.online]="connectionStatus() === 'connected'">
                {{ message.senderUsername.charAt(0).toUpperCase() }}
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <div class="online-indicator"></div>
                }
              </div>
            </div>
            
            <div class="message-content">
              <div class="message-header">
                <span class="username">{{ message.senderUsername }}</span>
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <span class="online-badge">ì˜¨ë¼ì¸</span>
                }
                <span class="timestamp">{{ formatTime(message.timestamp) }}</span>
              </div>
              
              <!-- ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€ -->
              @if (message.messageType === 'CHAT') {
                <div class="message-text">{{ message.content }}</div>
              }
              
              <!-- ì´ë¯¸ì§€/íŒŒì¼ ë©”ì‹œì§€ -->
              @if (message.messageType === 'IMAGE') {
                <div class="message-file">
                  @if (getImageData(message)?.type?.startsWith('image/')) {
                    <div class="image-preview" (click)="previewImage(message)">
                      <img [src]="getImageData(message)?.data" 
                           [alt]="getImageData(message)?.name"
                           class="preview-image">
                      <div class="image-info">
                        <span class="file-name">{{ getImageData(message)?.name }}</span>
                        <span class="file-size">({{ formatFileSize(getImageData(message)?.size) }})</span>
                      </div>
                    </div>
                  } @else {
                    <div class="file-preview" (click)="downloadFile(message)">
                      <mat-icon class="file-icon">attach_file</mat-icon>
                      <div class="file-info">
                        <span class="file-name">{{ getImageData(message)?.name }}</span>
                        <span class="file-size">({{ formatFileSize(getImageData(message)?.size) }})</span>
                      </div>
                      <mat-icon class="download-icon">download</mat-icon>
                    </div>
                  }
                </div>
              }
              
              <!-- ì…ì¥/í‡´ì¥ ë©”ì‹œì§€ -->
              @if (message.messageType === 'JOIN' || message.messageType === 'LEAVE') {
                <div class="message-text system-notice">
                  <mat-icon>{{ message.messageType === 'JOIN' ? 'login' : 'logout' }}</mat-icon>
                  {{ message.content }}
                </div>
              }
            </div>
          } @else {
            <!-- ì‹œìŠ¤í…œ ë©”ì‹œì§€ -->
            <div class="system-message-content">
              <mat-icon class="system-icon">info</mat-icon>
              <span class="system-text">{{ message.content }}</span>
              <span class="system-time">{{ formatTime(message.timestamp) }}</span>
            </div>
          }
        </div>
      }
    }
  </div>

  <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
  <div class="chat-input-area">
    <div class="input-container" [class.disabled]="connectionStatus() !== 'connected'">
      <input type="file" #fileInput (change)="onFileSelect($event)" 
             style="display: none;" 
             accept="image/*,video/*,.pdf,.doc,.docx,.txt,.zip">
      
      <button class="input-btn" title="íŒŒì¼ ì²¨ë¶€" 
              [disabled]="connectionStatus() !== 'connected'"
              (click)="fileInput.click()">
        <mat-icon>attach_file</mat-icon>
      </button>
      
      <textarea
        class="message-input"
        [(ngModel)]="newMessage"
        [placeholder]="getInputPlaceholder()"
        [disabled]="connectionStatus() !== 'connected'"
        (keydown)="onKeyDown($event)"
        rows="1"
        #messageInput>
      </textarea>
      
      <button class="input-btn" title="ì´ëª¨í‹°ì½˜"
              [disabled]="connectionStatus() !== 'connected'">
        <mat-icon>emoji_emotions</mat-icon>
      </button>
      
      <button 
        class="send-btn" 
        [disabled]="!newMessage().trim() || connectionStatus() !== 'connected'"
        (click)="sendCurrentMessage()"
        title="ë©”ì‹œì§€ ì „ì†¡">
        <mat-icon>send</mat-icon>
      </button>
    </div>
    
    <div class="input-hints">
      @if (connectionStatus() === 'connected') {
        <span><strong>Enter</strong>ë¡œ ì „ì†¡, <strong>Shift + Enter</strong>ë¡œ ì¤„ë°”ê¿ˆ</span>
        <span class="storage-info">â€¢ ë©”ëª¨ë¦¬ì— ìµœê·¼ 50ê°œ ë©”ì‹œì§€ ì €ì¥ ì¤‘ (Club ID: {{ chatRoomId() }})</span>
      } @else {
        <span class="connection-hint">{{ getConnectionStatusText() }} - ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</span>
      }
    </div>
  </div>
</div>