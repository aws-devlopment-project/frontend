<div class="chat-container">
  <!-- 채팅 헤더 -->
  <div class="chat-header">
    <div class="channel-info">
      <h3># {{ currentChannel().name || '채널' }}</h3>
      <div class="channel-status">
        <p>실시간 채팅방 (Club ID: {{ chatRoomId() }})</p>
        <div class="connection-status" [class]="getConnectionStatusClass()">
          <mat-icon class="status-icon">
            {{ connectionStatus() === 'connected' ? 'wifi' : 
               connectionStatus() === 'connecting' ? 'wifi_tethering' : 
               connectionStatus() === 'reconnecting' ? 'sync' : 'wifi_off' }}
          </mat-icon>
          <span>{{ getConnectionStatusText() }}</span>
        </div>
      </div>
    </div>
    <div class="chat-actions">
      <button class="header-btn" title="연결 테스트" (click)="testConnection()">
        <mat-icon>network_check</mat-icon>
      </button>
      @if (connectionStatus() === 'disconnected') {
        <button class="header-btn reconnect-btn" title="다시 연결" (click)="reconnect()">
          <mat-icon>refresh</mat-icon>
        </button>
      }
    </div>
  </div>

  <!-- 채팅 메시지 영역 -->
  <div class="chat-messages" #messagesContainer>
    @if (messages().length === 0) {
      <div class="welcome-message">
        <div class="welcome-content">
          <h4>🎉 채팅방에 오신 것을 환영합니다!</h4>
          <p>STOMP over WebSocket으로 실시간 채팅과 이미지를 즐겨보세요.</p>
          
          @if (connectionStatus() === 'connected') {
            <div class="conversation-starters">
              <h5>대화 시작하기</h5>
              <div class="starter-buttons">
                <button class="starter-btn" (click)="sendMessage('안녕하세요! 👋')">
                  안녕하세요! 👋
                </button>
                <button class="starter-btn" (click)="sendMessage('채팅 테스트입니다.')">
                  채팅 테스트입니다.
                </button>
                <button class="starter-btn" (click)="triggerImageUpload()">
                  이미지 업로드 📷
                </button>
              </div>
            </div>
          } @else {
            <div class="connection-waiting">
              <mat-icon class="loading-icon">{{ 
                connectionStatus() === 'connecting' ? 'hourglass_empty' :
                connectionStatus() === 'reconnecting' ? 'sync' : 'error_outline'
              }}</mat-icon>
              <p>{{ getConnectionStatusText() }}</p>
              @if (connectionStatus() === 'disconnected') {
                <button class="reconnect-button" (click)="reconnect()">
                  <mat-icon>refresh</mat-icon>
                  다시 연결
                </button>
              }
            </div>
          }
        </div>
      </div>
    } @else {
      @for (message of messages(); track message.id) {
        <div class="message-group" 
             [class.own-message]="message.isOwn"
             [class.system-message]="message.type === 'system'"
             [class.image-message]="isImageMessage(message)">
          
          @if (message.type !== 'system') {
            <div class="message-avatar">
              <div class="avatar-placeholder" [class.online]="connectionStatus() === 'connected'">
                {{ message.senderUsername.charAt(0).toUpperCase() }}
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <div class="online-indicator"></div>
                }
              </div>
            </div>
            
            <div class="message-content">
              <div class="message-header">
                <span class="username">{{ message.senderUsername }}</span>
                @if (connectionStatus() === 'connected' && !message.isOwn) {
                  <span class="online-badge">온라인</span>
                }
                <span class="timestamp">{{ formatTime(message.timestamp) }}</span>
              </div>
              
              <!-- 🖼️ 이미지 메시지 -->
              @if (isImageMessage(message)) {
                <div class="image-message-container">
                  <div class="image-wrapper">
                    <img 
                      [src]="getImageUrl(message.content)" 
                      alt="Shared image"
                      class="chat-image"
                      (error)="onImageError($event)"
                    />
                  </div>
                </div>
              }
              
              <!-- 일반 채팅 메시지 -->
              @if (message.messageType === 'CHAT') {
                <div class="message-text">{{ message.content }}</div>
              }
              
              <!-- 입장/퇴장 메시지 -->
              @if (message.messageType === 'JOIN' || message.messageType === 'LEAVE') {
                <div class="message-text system-notice">
                  <mat-icon>{{ message.messageType === 'JOIN' ? 'login' : 'logout' }}</mat-icon>
                  {{ message.content }}
                </div>
              }
            </div>
          } @else {
            <!-- 시스템 메시지 -->
            <div class="system-message-content">
              <mat-icon class="system-icon">info</mat-icon>
              <span class="system-text">{{ message.content }}</span>
              <span class="system-time">{{ formatTime(message.timestamp) }}</span>
            </div>
          }
        </div>
      }
    }
  </div>

  <!-- 메시지 입력 영역 -->
  <div class="chat-input-area">
    <!-- 🖼️ 숨겨진 파일 입력 -->
    <input 
      #fileInput
      type="file" 
      accept="image/*" 
      style="display: none"
      (change)="onImageSelected($event)"
    />
    
    <div class="input-container" [class.disabled]="connectionStatus() !== 'connected'">
      <!-- 🖼️ 이미지 업로드 버튼 -->
      <button 
        class="image-upload-btn" 
        [disabled]="connectionStatus() !== 'connected' || isUploadingImage()"
        (click)="triggerImageUpload()"
        title="이미지 업로드">
        @if (isUploadingImage()) {
          <mat-icon class="spinning">hourglass_empty</mat-icon>
        } @else {
          <mat-icon>image</mat-icon>
        }
      </button>
      
      <textarea
        class="message-input"
        [(ngModel)]="newMessage"
        [placeholder]="getInputPlaceholder()"
        [disabled]="connectionStatus() !== 'connected'"
        (keydown)="onKeyDown($event)"
        rows="1">
      </textarea>
      
      <button 
        class="send-btn" 
        [disabled]="!newMessage().trim() || connectionStatus() !== 'connected'"
        (click)="sendCurrentMessage()"
        title="메시지 전송">
        <mat-icon>send</mat-icon>
      </button>
    </div>
    
    <div class="input-hints">
      @if (connectionStatus() === 'connected') {
        <span><strong>Enter</strong>로 전송, <strong>Shift + Enter</strong>로 줄바꿈 | 📷 버튼으로 이미지 업로드</span>
      } @else {
        <span class="connection-hint">{{ getConnectionStatusText() }} - 메시지를 보낼 수 없습니다</span>
      }
    </div>
  </div>
</div>