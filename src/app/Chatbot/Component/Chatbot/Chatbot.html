<!-- ê°œì„ ëœ Chatbot.html - í”¼ë“œë°± ê¸°ëŠ¥ ë° Q&A í†µê³„ í¬í•¨ -->
<div class="chatbot-container">
  <!-- ì±—ë´‡ í† ê¸€ ë²„íŠ¼ -->
  <button 
    class="chatbot-toggle" 
    [class.minimized]="isMinimized()"
    [class.has-notifications]="hasNotifications()"
    [matBadge]="notificationCount()"
    [matBadgeHidden]="!hasNotifications()"
    matBadgeColor="warn"
    matBadgeSize="small"
    matBadgePosition="above before"
    (click)="toggleChatbot()"
    [attr.aria-label]="'ì±—ë´‡ ' + (isOpen() ? 'ë‹«ê¸°' : 'ì—´ê¸°')"
    type="button">
    
    @if (isMinimized()) {
      <mat-icon aria-hidden="true">chat_bubble</mat-icon>
    } @else {
      <mat-icon aria-hidden="true">smart_toy</mat-icon>
    }
  </button>

  <!-- ì±—ë´‡ ì°½ -->
  @if (isOpen()) {
    <div class="chatbot-window" role="dialog" aria-labelledby="chatbot-title" aria-modal="false">
      <!-- í—¤ë” -->
      <header class="chatbot-header">
        <div class="header-info">
          <div class="bot-avatar" aria-hidden="true">ğŸ¤–</div>
          <div class="bot-details">
            <h2 id="chatbot-title" class="bot-name">AI ì–´ì‹œìŠ¤í„´íŠ¸</h2>
          </div>
        </div>
        <div class="header-actions">
          <button 
            class="header-btn" 
            (click)="toggleQAStats()" 
            aria-label="Q&A í†µê³„"
            [matTooltip]="'Q&A í†µê³„ ' + (showQAStats() ? 'ìˆ¨ê¸°ê¸°' : 'ë³´ê¸°')"
            type="button">
            <mat-icon aria-hidden="true">analytics</mat-icon>
          </button>
          <button 
            class="header-btn" 
            (click)="minimize()" 
            aria-label="ìµœì†Œí™”"
            type="button">
            <mat-icon aria-hidden="true">remove</mat-icon>
          </button>
          <button 
            class="header-btn" 
            (click)="closeChatbot()" 
            aria-label="ì±„íŒ… ë‹«ê¸°"
            type="button">
            <mat-icon aria-hidden="true">close</mat-icon>
          </button>
        </div>
      </header>

      <!-- Q&A í†µê³„ íŒ¨ë„ (ì„ íƒì  í‘œì‹œ) -->
      @if (showQAStats()) {
        <div class="qa-stats-panel">
          <h3>ğŸ“Š Q&A ì§€ì‹ ë² ì´ìŠ¤</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">ì´ Q&A</span>
              <span class="stat-value">{{ qaStats()?.totalItems || 0 }}ê°œ</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ì¹´í…Œê³ ë¦¬</span>
              <span class="stat-value">{{ getCategoryCount() }}ê°œ</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ì‘ë‹µ í’ˆì§ˆ</span>
              <span class="stat-value">{{ getPerformanceStats()?.responseQuality || 0 }}%</span>
            </div>
          </div>
          
          <!-- Q&A íŒŒì¼ ì—…ë¡œë“œ (ê´€ë¦¬ì ê¸°ëŠ¥) -->
          <div class="upload-section">
            <input 
              type="file" 
              accept=".txt" 
              (change)="uploadQAFile($event)"
              #fileInput
              style="display: none;">
            <button 
              class="upload-btn" 
              (click)="fileInput.click()"
              type="button">
              ğŸ“ Q&A íŒŒì¼ ì—…ë¡œë“œ
            </button>
          </div>
        </div>
      }

      <!-- ë©”ì‹œì§€ ì˜ì—­ -->
      <main 
        class="chatbot-messages" 
        #chatMessages
        role="log" 
        aria-label="ì±„íŒ… ë©”ì‹œì§€"
        aria-live="polite"
        tabindex="0">
        
        @if (isEmpty()) {
          <!-- ë¹ˆ ìƒíƒœ -->
          <div class="empty-chat" role="status">
            <div class="welcome-icon" aria-hidden="true">ğŸ’¬</div>
            <p>ì±„íŒ…ì„ ì‹œì‘í•´ë³´ì„¸ìš”!</p>
            
            <!-- ë¹ ë¥¸ ì•¡ì…˜ ë²„íŠ¼ë“¤ -->
            <nav class="quick-actions" aria-label="ë¹ ë¥¸ ì•¡ì…˜">
              @for (action of quickActions(); track action) {
                <button 
                  class="quick-action-btn" 
                  (click)="onQuickAction(action)"
                  type="button">
                  {{ action }}
                </button>
              }
            </nav>
          </div>
        } @else {
          <!-- ë©”ì‹œì§€ ë¦¬ìŠ¤íŠ¸ -->
          @for (message of messages(); track trackByMessageId($index, message)) {
            <article 
              class="message-wrapper" 
              [class.user-message]="message.isUser"
              [class.bot-message]="!message.isUser"
              [attr.data-message-id]="message.id">
              
              <div class="message-content">
                <div 
                  class="message-bubble" 
                  [class.user-bubble]="message.isUser"
                  [class.bot-bubble]="!message.isUser"
                  role="group"
                  [attr.aria-label]="message.isUser ? 'ì‚¬ìš©ì ë©”ì‹œì§€' : 'ë´‡ ì‘ë‹µ'">
                  
                  <!-- ë©”ì‹œì§€ í…ìŠ¤íŠ¸ -->
                  <div class="message-text-container">
                    <p 
                      [attr.data-username]="message.isUser ? 'ë‹¹ì‹ ' : ''"
                      [innerHTML]="message.text"
                      class="message-text">
                    </p>
                    
                    <!-- íƒ€ì„ìŠ¤íƒ¬í”„ -->
                    <time 
                      class="message-time"
                      [attr.datetime]="message.timestamp | date:'yyyy-MM-ddTHH:mm:ss'"
                      [title]="message.timestamp | date:'yyyyë…„ MMì›” ddì¼ HH:mm:ss'">
                      {{ message.timestamp | date:'HH:mm' }}
                    </time>
                  </div>
                </div>
              </div>
            </article>
          }
        }

        <!-- íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° -->
        @if (isTyping()) {
          <div 
            class="message-wrapper bot-message" 
            role="status" 
            aria-label="ë´‡ì´ ì…ë ¥ ì¤‘ì…ë‹ˆë‹¤">
            <div class="message-content">
              <div class="message-bubble bot-bubble">
                <div class="typing-indicator" aria-hidden="true">
                  <span></span>
                  <span></span>
                  <span></span>
                </div>
                <span class="sr-only">Q&A ê²€ìƒ‰ ë° ì‘ë‹µ ìƒì„± ì¤‘...</span>
              </div>
            </div>
          </div>
        }
      </main>

      <!-- ì…ë ¥ ì˜ì—­ -->
      <footer class="chatbot-input">
        <form class="input-container" (ngSubmit)="sendMessage()" novalidate>
          <label for="chat-input" class="sr-only">ë©”ì‹œì§€ ì…ë ¥</label>
          <input 
            #userInputRef
            id="chat-input"
            class="native-input"
            placeholder="ë©”ì‹œì§€ ë³´ë‚´ê¸°... (Q&A ê²€ìƒ‰ ê°€ëŠ¥)"
            [value]="userInputValue()"
            (input)="userInputValue.set($any($event.target).value)"
            (keydown)="onInputKeyPress($event)"
            [disabled]="isTyping()"
            [attr.aria-describedby]="isTyping() ? 'typing-status' : null"
            maxlength="500"
            autocomplete="off"
            spellcheck="true"
            type="text">
          
          <!-- ìˆ¨ê¹€ ìƒíƒœ í‘œì‹œ -->
          @if (isTyping()) {
            <div id="typing-status" class="sr-only" aria-live="polite">
              Q&A ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê²€ìƒ‰í•˜ë©° ì‘ë‹µì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤
            </div>
          }
          
          <button 
            class="send-button"
            [disabled]="!canSend()"
            type="submit"
            [attr.aria-label]="canSend() ? 'ë©”ì‹œì§€ ë³´ë‚´ê¸°' : 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'">
            <mat-icon aria-hidden="true">send</mat-icon>
          </button>
        </form>

        <!-- ë¹ ë¥¸ ì•¡ì…˜ (ë©”ì‹œì§€ê°€ ì ì„ ë•Œë§Œ í‘œì‹œ) -->
        @if (messages().length <= 1) {
          <nav class="input-quick-actions" aria-label="ë¹ ë¥¸ ì§ˆë¬¸">
            @for (action of quickActions().slice(0, 4); track action) {
              <button 
                class="quick-action-chip" 
                (click)="onQuickAction(action)"
                [disabled]="isTyping()"
                type="button"
                [attr.aria-label]="'ë¹ ë¥¸ ì§ˆë¬¸: ' + action">
                {{ action }}
              </button>
            }
          </nav>
        }
      </footer>
    </div>
  }
</div>