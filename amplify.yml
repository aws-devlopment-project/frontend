version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing dependencies..."
            - npm ci
            - echo "Creating minimal environment files..."
            # 최소한의 환경 파일 생성 (빌드 에러 방지)
            - |
              cat <<EOF > src/environments/environment.prod.ts
              export const environment = {
                production: true,
                userPoolId: '',
                userPoolClientId: '',
                identityPoolId: '',
                region: 'ap-northeast-2',
                googleClientId: '',
                apiUrl: '',
                cognitoDomain: '',
                redirectSignIn: '',
                redirectSignOut: ''
              };
              EOF
            # 개발 환경 파일도 생성
            - |
              cat <<EOF > src/environments/environment.ts
              export const environment = {
                production: false,
                userPoolId: '',
                userPoolClientId: '',
                identityPoolId: '',
                region: 'ap-northeast-2',
                googleClientId: '',
                apiUrl: '',
                cognitoDomain: '',
                redirectSignIn: '',
                redirectSignOut: ''
              };
              EOF
            # AWS exports 파일 생성 (최소 설정)
            - |
              cat <<EOF > src/aws-exports.ts
              const awsconfig = {
                aws_project_region: 'ap-northeast-2',
                aws_cognito_region: 'ap-northeast-2',
                aws_user_pools_id: '',
                aws_user_pools_web_client_id: '',
                aws_cognito_identity_pool_id: '',
                oauth: {},
                aws_cognito_username_attributes: [],
                aws_cognito_social_providers: [],
                aws_cognito_signup_attributes: [],
                aws_cognito_mfa_configuration: 'OFF',
                aws_cognito_password_protection_settings: {
                  passwordPolicyMinLength: 8,
                  passwordPolicyCharacters: []
                },
                aws_cognito_verification_mechanisms: [],
                Auth: {
                  Cognito: {
                    userPoolId: '',
                    userPoolClientId: '',
                    identityPoolId: '',
                    signUpVerificationMethod: 'code' as const,
                    loginWith: {
                      username: false,
                      email: false,
                      phone: false
                    }
                  }
                }
              };
              
              export default awsconfig;
              EOF
        build:
          commands:
            - echo "Building Angular application..."
            - npm run build -- --configuration production
        postBuild:
          commands:
            - echo "Build completed successfully!"
            - echo "Files ready for S3 upload:"
            - ls -la dist/frontend/browser/
            - echo "Generated environment files (empty values for now):"
            - cat src/environments/environment.prod.ts
      artifacts:
        baseDirectory: dist/frontend/browser
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .angular/cache/**/*
